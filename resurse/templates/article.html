<!DOCTYPE html>
<html>
    <head>
        <title>Home Page</title>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <script type="text/javascript" src="{{resurse}}/js/jquery-2.0.0.min.js"></script>
        <script type="text/javascript" src="{{resurse}}/js/default.js"></script>
        <link rel="stylesheet" href="http://yui.yahooapis.com/pure/0.1.0/base-min.css">
        <link rel="stylesheet" href="http://yui.yahooapis.com/pure/0.1.0/buttons-min.css">
        <link rel="stylesheet" href="http://yui.yahooapis.com/pure/0.1.0/menus-min.css">
        <link rel="stylesheet" href="http://yui.yahooapis.com/pure/0.1.0/forms-min.css">
        <link href="{{resurse}}/css/default.css" rel="stylesheet" type="text/css">
        <link href="{{resurse}}/css/article.css" rel="stylesheet" type="text/css">
        <script type="text/javascript">
        $(document).ready(function () {
            var errorMessage = new App.message.Error(),
                addComments = function () {
                    $.ajax({
                        type: 'GET',
                        url: '{{api}}/comments',
                        cache: false,
                        data: {
                            articleId: '{{article.id}}'
                        },
                        success: function (data, status, request) {
                            if (data.status === 'ok') {
                                var target = $('.js-comments'),
                                    comments = $('<div></div>');

                                $.each(data.result, function(key, value) {
                                    comments.append(App.articles.Comment(value));
                                });

                                target.empty();
                                target.append(comments.html());
                            } else {
                                errorMessage.show('Error Sending Data.');
                            }
                        },
                        error: function () {
                            errorMessage.show('Error Sending Data.');
                        }
                    });
                };
                addComments();
                $('.js-add-button-click').click(function () {
                    var button = $(this).attr('disabled', 'disabled'),
                        name = $('.js-name').val(),
                        comment = $('.js-comment').val(),
                        hasError = false;

                    errorMessage.hide();
                    if (name.length === 0 && name !== ' ') {
                        errorMessage.addMessage('Name field cannot be empty or space filled.');
                        hasError = true;
                    }

                    if (comment.length === 0 && comment !== ' ') {
                        errorMessage.addMessage('Comment field cannot be empty or space filled.');
                        hasError = true;
                    }

                    if (hasError) {
                        errorMessage.show();
                        button.removeAttr('disabled');
                        return false;
                    }
                    $.ajax({
                        type: 'POST',
                        url: '{{api}}/create-comment',
                        data: {
                            name: name,
                            comment: comment,
                            articleId: '{{article.id}}'
                        },
                        success: function (data, status, request) {
                            if (data.status === 'ok') {
                               addComments();
                               $('.js-comment').val('');
                            } else {
                                errorMessage.show('Error Sending Data.');
                            }
                            button.removeAttr('disabled');
                        },
                        error: function () {
                            button.removeAttr('disabled');
                            errorMessage.show('Error Sending Data.');
                        }
                    });

                    return false;
                });
            });
        </script>
    </head>
    <body>
        {% include 'header.html' %}
        <div id="content">
            <div class="container article">
                <h2>{{article.title}}</h2>
                <div>Author: {{article.author}}</div>
                <div>Date: {{article.create_date|date(config.dateFormat)}}</div>
                <pre>{{article.content}}</pre>
                <div>Tags: {{article.tags|upper}}</div>
            </div>
            <div class="container comment-form">
                <h3>Comment</h3>
                <div class="pure-form pure-form-stacked">
                    <label for="user-name">Name</label>
                    <input type="text" id="user-name" placeholder="Name" class="js-name" value="{{name}}">
                    <label for="user-comment">Comment</label>
                    <textarea id="user-comment" class="js-comment"></textarea>
                    <button class="pure-button pure-button-primary js-add-button-click">Add</button>
                </div>
            </div>
            <div class="container comments js-comments">
            </div>
        </div>
        {% include 'footer.html' %}
    </body>
</html>